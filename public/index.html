<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="shortcut icon" href="assets/icons/home.png">
    <link rel="stylesheet" href="/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">


</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_BASE = 'http://localhost:3001/api';

        function KanbanBoard() {
            const [board, setBoard] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [draggedCard, setDraggedCard] = useState(null);
            const [draggedList, setDraggedList] = useState(null);
            const [dragOverList, setDragOverList] = useState(null);
            const [dragOverCard, setDragOverCard] = useState(null);
            const [showAddList, setShowAddList] = useState(false);
            const [showAddCard, setShowAddCard] = useState(null);
            const [editingCard, setEditingCard] = useState(null);
            const [editingList, setEditingList] = useState(null);

            useEffect(() => {
                fetchBoard();
            }, []);

            const fetchBoard = async () => {
                try {
                    const response = await fetch(`${API_BASE}/boards`);
                    const boards = await response.json();

                    if (boards.length > 0) {
                        const boardResponse = await fetch(`${API_BASE}/boards/${boards[0].id}`);
                        const boardData = await boardResponse.json();
                        setBoard(boardData);
                    }
                    setLoading(false);
                } catch (err) {
                    setError('Failed to fetch board data');
                    setLoading(false);
                }
            };

            const addList = async (title) => {
                try {
                    const response = await fetch(`${API_BASE}/lists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ board_id: board.id, title })
                    });
                    const newList = await response.json();
                    setBoard(prev => ({
                        ...prev,
                        lists: [...prev.lists, newList]
                    }));
                    setShowAddList(false);
                } catch (err) {
                    setError('Failed to add list');
                }
            };

            const updateList = async (listId, title) => {
                try {
                    await fetch(`${API_BASE}/lists/${listId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title })
                    });

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list =>
                            list.id === listId ? { ...list, title } : list
                        )
                    }));
                    setEditingList(null);
                } catch (err) {
                    setError('Failed to update list');
                }
            };

            const addCard = async (listId, title, description, dueDate, priority) => {
                try {
                    console.log('Adding card with priority:', priority); // Debug log

                    const response = await fetch(`${API_BASE}/cards`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            list_id: listId,
                            title,
                            description,
                            due_date: dueDate || null,
                            priority
                        })
                    });

                    const newCard = await response.json();
                    console.log('Received card from API:', newCard); // Debug log

                    // Ensure the card has the priority field
                    const cardWithPriority = {
                        ...newCard,
                        priority: newCard.priority || priority, // Fallback to the sent priority
                        due_date: newCard.due_date || (dueDate || null)
                    };

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list =>
                            list.id === listId
                                ? { ...list, cards: [...list.cards, cardWithPriority] }
                                : list
                        )
                    }));
                    setShowAddCard(null);
                } catch (err) {
                    console.error('Error adding card:', err); // Debug log
                    setError('Failed to add card');
                }
            };


            const updateCard = async (cardId, title, description, dueDate, priority) => {
                try {
                    await fetch(`${API_BASE}/cards/${cardId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            due_date: dueDate || null,
                            priority
                        })
                    });

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list => ({
                            ...list,
                            cards: list.cards.map(card =>
                                card.id === cardId
                                    ? { ...card, title, description, due_date: dueDate, priority }
                                    : card
                            )
                        }))
                    }));
                    setEditingCard(null);
                } catch (err) {
                    setError('Failed to update card');
                }
            };

            const deleteCard = async (cardId) => {
                try {
                    await fetch(`${API_BASE}/cards/${cardId}`, {
                        method: 'DELETE'
                    });

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list => ({
                            ...list,
                            cards: list.cards.filter(card => card.id !== cardId)
                        }))
                    }));
                    setEditingCard(null);
                } catch (err) {
                    setError('Failed to delete card');
                }
            };

            const deleteList = async (listId) => {
                try {
                    await fetch(`${API_BASE}/lists/${listId}`, {
                        method: 'DELETE'
                    });

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.filter(list => list.id !== listId)
                    }));
                } catch (err) {
                    setError('Failed to delete list');
                }
            };

            const handleDragStart = (e, card) => {
                setDraggedCard(card);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = (e) => {
                e.target.classList.remove('dragging');
                setDraggedCard(null);
                setDraggedList(null);
                setDragOverList(null);
                setDragOverCard(null);
            };

            // List drag handlers
            const handleListDragStart = (e, list) => {
                setDraggedList(list);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };


            const handleListDragEnd = (e) => {
                e.target.classList.remove('dragging');
                setDraggedList(null);
                setDragOverList(null);
            };

            const handleListDragOver = (e, listId) => {
                e.preventDefault();
                e.stopPropagation();

                // If we're dragging a list over another list
                if (draggedList && draggedList.id !== listId) {
                    e.dataTransfer.dropEffect = 'move';
                    setDragOverList(listId);
                    return;
                }

                // If we're dragging a card
                if (draggedCard) {
                    e.dataTransfer.dropEffect = 'move';
                    setDragOverList(listId);
                }
            };

            const handleListDragLeave = (e) => {
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    setDragOverList(null);
                }
            };

            const handleCardDragOver = (e, card) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                setDragOverCard(card.id);
            };

            const handleCardDragLeave = (e) => {
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    setDragOverCard(null);
                }
            };

            const handleListDrop = async (e, targetListId) => {
                e.preventDefault();
                e.stopPropagation();

                // Handle list reordering - simple replacement behavior
                if (draggedList && draggedList.id !== targetListId) {
                    await reorderList(draggedList.id, targetListId);
                    setDragOverList(null);
                    return;
                }

                // Handle card movement
                if (draggedCard && draggedCard.list_id !== targetListId) {
                    await moveCard(draggedCard.id, targetListId, 0);
                }

                setDragOverList(null);
                setDragOverCard(null);
            };

            // Board-level drop handler for dropping at the end
            const handleBoardDragOver = (e) => {
                if (draggedList) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                }
            };

            const handleBoardDrop = (e) => {
                e.preventDefault();
                if (draggedList) {
                    // Move to the end
                    reorderList(draggedList.id, null);
                }
            };

            const reorderList = async (draggedListId, targetListId) => {
                try {
                    const currentLists = [...board.lists];
                    const draggedIndex = currentLists.findIndex(list => list.id === draggedListId);

                    if (draggedIndex === -1) return;

                    let targetIndex;

                    if (targetListId === null) {
                        // Drop at the end
                        targetIndex = currentLists.length - 1;
                    } else {
                        targetIndex = currentLists.findIndex(list => list.id === targetListId);
                        if (targetIndex === -1) return;
                    }

                    // Simple swap behavior: remove dragged list and insert at target position
                    const [draggedListItem] = currentLists.splice(draggedIndex, 1);
                    currentLists.splice(targetIndex, 0, draggedListItem);

                    // Update positions to match array indices
                    const updatedLists = currentLists.map((list, index) => ({
                        ...list,
                        position: index
                    }));

                    // Update UI immediately
                    setBoard(prev => ({
                        ...prev,
                        lists: updatedLists
                    }));

                    // Send to backend
                    await fetch(`${API_BASE}/lists/${draggedListId}/reorder`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ position: targetIndex })
                    });

                } catch (err) {
                    setError('Failed to reorder list');
                    // Refresh board to get correct order
                    fetchBoard();
                }
            };

            const handleCardDrop = async (e, targetCard) => {
                e.preventDefault();
                e.stopPropagation();
                setDragOverList(null);
                setDragOverCard(null);

                if (!draggedCard || draggedCard.id === targetCard.id) return;

                // Calculate position based on drop position
                const rect = e.currentTarget.getBoundingClientRect();
                const dropY = e.clientY;
                const cardMiddle = rect.top + rect.height / 2;
                const isDroppedAfter = dropY > cardMiddle;

                const targetList = board.lists.find(list => list.id === targetCard.list_id);
                const targetIndex = targetList.cards.findIndex(card => card.id === targetCard.id);
                const newPosition = isDroppedAfter ? targetIndex + 1 : targetIndex;

                await moveCard(draggedCard.id, targetCard.list_id, newPosition);
            };

            const moveCard = async (cardId, targetListId, position) => {
                try {
                    await fetch(`${API_BASE}/cards/${cardId}/move`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            list_id: targetListId,
                            position: position
                        })
                    });

                    // Update local state
                    setBoard(prev => {
                        const newBoard = { ...prev };
                        let movedCard = null;

                        // Remove card from source list
                        newBoard.lists = newBoard.lists.map(list => {
                            if (list.cards.some(card => card.id === cardId)) {
                                movedCard = list.cards.find(card => card.id === cardId);
                                return {
                                    ...list,
                                    cards: list.cards.filter(card => card.id !== cardId)
                                };
                            }
                            return list;
                        });

                        // Add card to target list at specified position
                        newBoard.lists = newBoard.lists.map(list => {
                            if (list.id === targetListId) {
                                const newCards = [...list.cards];
                                const updatedCard = { ...movedCard, list_id: targetListId };
                                newCards.splice(position, 0, updatedCard);
                                return { ...list, cards: newCards };
                            }
                            return list;
                        });

                        return newBoard;
                    });
                } catch (err) {
                    setError('Failed to move card');
                }
            };

            if (loading) return <div className="loading">Loading your Kanban board...</div>;
            if (error) return <div className="error">{error}</div>;
            if (!board) return <div className="loading">No board found</div>;

            return (
                <div className="app">
                    <div className="header">
                        <h1>Kanban Board</h1>
                    </div>

                    <div className="action-bar">
                        <button className="add-list-button" onClick={() => setShowAddList(true)}>
                            <i className="fas fa-plus"></i>
                            Add List
                        </button>
                        <div className="views">
                            <button><i className="fas fa-th-large"></i></button>
                            <button><i className="fas fa-list"></i></button>
                        </div>
                    </div>

                    <div
                        className="board"
                        onDragOver={handleBoardDragOver}
                        onDrop={handleBoardDrop}
                    >
                        {board.lists.map(list => (
                            <div
                                key={list.id}
                                className={`list ${dragOverList === list.id ? 'drag-over' : ''} ${draggedList && draggedList.id === list.id ? 'dragging' : ''}`}
                                draggable
                                onDragStart={(e) => handleListDragStart(e, list)}
                                onDragEnd={handleListDragEnd}
                                onDragOver={(e) => handleListDragOver(e, list.id)}
                                onDragLeave={handleListDragLeave}
                                onDrop={(e) => handleListDrop(e, list.id)}
                            >
                                <div className="list-header">
                                    <div className="list-drag-handle">
                                        <i className="fas fa-grip-vertical"></i>
                                    </div>
                                    {editingList === list.id ? (
                                        <EditListTitle
                                            list={list}
                                            onSave={updateList}
                                            onCancel={() => setEditingList(null)}
                                        />
                                    ) : (
                                        <h3
                                            className="list-title"
                                            onDoubleClick={() => setEditingList(list.id)}
                                        >
                                            {list.title}
                                        </h3>
                                    )}
                                    <button
                                        className="delete-button"
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            deleteList(list.id);
                                        }}
                                    >
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </div>

                                <div className="list-content">
                                    {list.cards.map(card => (
                                        <div
                                            key={card.id}
                                            className={`card ${dragOverCard === card.id ? 'drag-over' : ''} priority-${card.priority || 'medium'}`}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, card)}
                                            onDragEnd={handleDragEnd}
                                            onDragOver={(e) => handleCardDragOver(e, card)}
                                            onDragLeave={handleCardDragLeave}
                                            onDrop={(e) => handleCardDrop(e, card)}
                                            onClick={() => setEditingCard(card)}
                                        >
                                            <div className="card-title">{card.title}</div>
                                            {card.description && (
                                                <div className="card-description">{card.description}</div>
                                            )}
                                            <div className="card-meta">
                                                {card.due_date && (
                                                    <div className={`card-due-date ${new Date(card.due_date) < new Date() ? 'overdue' : ''}`}>
                                                        <i className="fas fa-calendar"></i>
                                                        {new Date(card.due_date).toLocaleDateString()}
                                                    </div>
                                                )}
                                                <div className={`card-priority priority-${card.priority || 'medium'}`}>
                                                    <i className="fas fa-flag"></i>
                                                    {(card.priority || 'medium').charAt(0).toUpperCase() + (card.priority || 'medium').slice(1)}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button
                                    className="add-button"
                                    onClick={() => setShowAddCard(list.id)}
                                >
                                    <i className="fas fa-plus"></i>
                                    Add Card
                                </button>
                            </div>
                        ))}
                    </div>

                    {showAddList && (
                        <AddListModal
                            onSave={addList}
                            onClose={() => setShowAddList(false)}
                        />
                    )}

                    {showAddCard && (
                        <AddCardModal
                            onSave={(title, description, dueDate, priority) => addCard(showAddCard, title, description, dueDate, priority)}
                            onClose={() => setShowAddCard(null)}
                        />
                    )}

                    {editingCard && (
                        <EditCardModal
                            card={editingCard}
                            onSave={updateCard}
                            onDelete={deleteCard}
                            onClose={() => setEditingCard(null)}
                        />
                    )}
                </div>
            );
        }

        function AddListModal({ onSave, onClose }) {
            const [title, setTitle] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    onSave(title.trim());
                    setTitle('');
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content">
                        <h3>Add New List</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="List title"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                autoFocus
                                className="modal-input"
                            />
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fa-solid fa-plus"></i>
                                    Add List
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditListTitle({ list, onSave, onCancel }) {
            const [title, setTitle] = useState(list.title);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim() && title.trim() !== list.title) {
                    onSave(list.id, title.trim());
                } else {
                    onCancel();
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit(e);
                } else if (e.key === 'Escape') {
                    onCancel();
                }
            };

            const handleBlur = () => {
                if (title.trim() && title.trim() !== list.title) {
                    onSave(list.id, title.trim());
                } else {
                    onCancel();
                }
            };

            return (
                <input
                    type="text"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    onKeyDown={handleKeyDown}
                    onBlur={handleBlur}
                    autoFocus
                    className="list-title-input"
                />
            );
        }

        function AddCardModal({ onSave, onClose }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [dueDate, setDueDate] = useState('');
            const [priority, setPriority] = useState('medium');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    onSave(title.trim(), description.trim(), dueDate, priority);
                    setTitle('');
                    setDescription('');
                    setDueDate('');
                    setPriority('medium');
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>Add New Card</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="Card title"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                autoFocus
                                className="modal-input"
                            />
                            <textarea
                                placeholder="Card description (optional)"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="modal-textarea"
                            />
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Due Date:</label>
                                    <input
                                        type="date"
                                        value={dueDate}
                                        onChange={(e) => setDueDate(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Priority:</label>
                                    <select
                                        value={priority}
                                        onChange={(e) => setPriority(e.target.value)}
                                        className="modal-select"
                                    >
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fa-solid fa-plus"></i>
                                    Add Card
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditCardModal({ card, onSave, onDelete, onClose }) {
            const [title, setTitle] = useState(card.title);
            const [description, setDescription] = useState(card.description || '');
            const [dueDate, setDueDate] = useState(card.due_date || '');
            const [priority, setPriority] = useState(card.priority || 'medium');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    onSave(card.id, title.trim(), description.trim(), dueDate, priority);
                }
            };

            const handleDelete = () => {
                if (confirm('Are you sure you want to delete this card?')) {
                    onDelete(card.id);
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>Edit Card</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="Card title"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="modal-input"
                            />
                            <textarea
                                placeholder="Card description"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="modal-textarea"
                            />
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Due Date:</label>
                                    <input
                                        type="date"
                                        value={dueDate}
                                        onChange={(e) => setDueDate(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Priority:</label>
                                    <select
                                        value={priority}
                                        onChange={(e) => setPriority(e.target.value)}
                                        className="modal-select"
                                    >
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fas fa-save"></i>
                                    Save
                                </button>
                                <button type="button" className="delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                    Delete
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<KanbanBoard />, document.getElementById('root'));
    </script>
</body>

</html>