<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauler Kanban</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="shortcut icon" href="assets/icons/home.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API base URL - automatically detect based on current host
        const API_BASE = window.location.origin + '/api';

        const formatDateForInput = (dateString) => {
            if (!dateString) return '';

            // If it's already in YYYY-MM-DD format, return as is
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateString;
            }

            // If it contains 'T' (ISO format), extract just the date part
            if (typeof dateString === 'string' && dateString.includes('T')) {
                return dateString.split('T')[0];
            }

            // If it's a Date object, handle it carefully
            if (dateString instanceof Date) {
                const year = dateString.getFullYear();
                const month = String(dateString.getMonth() + 1).padStart(2, '0');
                const day = String(dateString.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // For other string formats, try to parse as local date
            try {
                // If it looks like a date string from MySQL (YYYY-MM-DD), 
                // create a date object in local timezone
                if (typeof dateString === 'string') {
                    const dateParts = dateString.split('-');
                    if (dateParts.length === 3) {
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1; // Month is 0-based
                        const day = parseInt(dateParts[2], 10);
                        const date = new Date(year, month, day);

                        const resultYear = date.getFullYear();
                        const resultMonth = String(date.getMonth() + 1).padStart(2, '0');
                        const resultDay = String(date.getDate()).padStart(2, '0');
                        return `${resultYear}-${resultMonth}-${resultDay}`;
                    }
                }

                // Fallback: try to parse as regular date
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return '';
            }
        };

        const formatDateForDisplay = (dateString) => {
            if (!dateString) return '';

            try {
                // If it's in YYYY-MM-DD format, create date object carefully
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
                    // Create date object in local timezone
                    const date = new Date(year, month - 1, day);
                    return date.toLocaleDateString('ca-ES');
                }

                // Handle other formats
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;

                return date.toLocaleDateString('ca-ES');
            } catch (error) {
                console.error('Error displaying date:', error);
                return dateString;
            }
        };

        const formatDateTimeForInput = (dateTimeString) => {
            if (!dateTimeString) return '';

            try {
                // If it's already in the correct format for datetime-local (YYYY-MM-DDTHH:mm)
                if (typeof dateTimeString === 'string' && dateTimeString.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                    return dateTimeString; // Already in correct format
                }

                // If it's an ISO string (2025-06-28T18:00:00.000Z), extract date and time
                if (typeof dateTimeString === 'string' && dateTimeString.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                    // Extract just the date and time part, ignore milliseconds and timezone
                    const [datePart, timeWithTz] = dateTimeString.split('T');
                    const timePart = timeWithTz.split('.')[0]; // Remove milliseconds and timezone
                    return `${datePart}T${timePart.substring(0, 5)}`; // Keep only HH:mm
                }

                // If it's a MySQL datetime string (YYYY-MM-DD HH:mm:ss), just convert format
                if (typeof dateTimeString === 'string' && dateTimeString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                    return dateTimeString.replace(' ', 'T').substring(0, 16);
                }

                return '';
            } catch (error) {
                console.error('Error formatting datetime:', error);
                return '';
            }
        };

        const formatDateTimeForDisplay = (dateTimeString) => {
            if (!dateTimeString) return '';

            try {
                // If it's a MySQL datetime string (YYYY-MM-DD HH:mm:ss), just format for display
                if (typeof dateTimeString === 'string' && dateTimeString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                    const [datePart, timePart] = dateTimeString.split(' ');
                    const [year, month, day] = datePart.split('-');
                    const [hours, minutes] = timePart.split(':');

                    // Format as "DD/MM/YYYY HH:mm"
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                // If it's an ISO string (2025-06-28T18:00:00.000Z), convert to local time display
                if (typeof dateTimeString === 'string' && dateTimeString.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                    // Extract just the date and time part, ignore timezone info
                    const [datePart, timeWithTz] = dateTimeString.split('T');
                    const timePart = timeWithTz.split('.')[0]; // Remove milliseconds and timezone
                    const [year, month, day] = datePart.split('-');
                    const [hours, minutes] = timePart.split(':');

                    // Format as "DD/MM/YYYY HH:mm"
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                return dateTimeString;
            } catch (error) {
                console.error('Error displaying datetime:', error);
                return dateTimeString;
            }
        };

        function KanbanBoard() {
            const [board, setBoard] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentView, setCurrentView] = useState(() => { return localStorage.getItem('kanban-current-view') || 'board'; });
            const [theme, setTheme] = useState(() => { return localStorage.getItem('kanban-theme') || 'light'; });
            const [showFilters, setShowFilters] = useState(() => { return localStorage.getItem('kanban-show-filters') !== 'false'; });
            const [draggedCard, setDraggedCard] = useState(null);
            const [draggedList, setDraggedList] = useState(null);
            const [dragOverList, setDragOverList] = useState(null);
            const [dragOverCard, setDragOverCard] = useState(null);
            const [showAddList, setShowAddList] = useState(false);
            const [showAddCard, setShowAddCard] = useState(null);
            const [editingCard, setEditingCard] = useState(null);
            const [editingList, setEditingList] = useState(null);
            const [showActionsDropdown, setShowActionsDropdown] = useState(false);
            const [filters, setFilters] = useState({
                search: '',
                priority: 'all',
                dueDate: 'all'
            });
            const [confirmation, setConfirmation] = useState({
                isOpen: false,
                title: '',
                message: '',
                onConfirm: null,
                confirmText: 'SÃ­',
                cancelText: 'No',
                isDestructive: false
            });

            // Make the update function available globally for the calendar component
            useEffect(() => {
                window.updateBoardAfterCardUpdate = updateCardInBoard;

                // Cleanup on unmount
                return () => {
                    delete window.updateBoardAfterCardUpdate;
                };
            }, []);

            useEffect(() => {
                fetchBoard();
                localStorage.setItem('kanban-current-view', currentView);
            }, [currentView]);

            // Add theme effect
            useEffect(() => {
                localStorage.setItem('kanban-theme', theme);
                document.body.setAttribute('data-theme', theme);
            }, [theme]);

            // Add filter visibility effect
            useEffect(() => {
                localStorage.setItem('kanban-show-filters', showFilters);
            }, [showFilters]);

            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showActionsDropdown && !event.target.closest('.actions-dropdown-container')) {
                        setShowActionsDropdown(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [showActionsDropdown]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            const toggleFilters = () => {
                setShowFilters(prev => !prev);
            };

            // Helper function to show confirmation
            const showConfirmation = ({ title, message, onConfirm, confirmText = 'Yes', cancelText = 'No', isDestructive = false }) => {
                setConfirmation({
                    isOpen: true,
                    title,
                    message,
                    onConfirm: () => {
                        onConfirm();
                        hideConfirmation();
                    },
                    confirmText,
                    cancelText,
                    isDestructive
                });
            };

            const hideConfirmation = () => {
                setConfirmation({
                    isOpen: false,
                    title: '',
                    message: '',
                    onConfirm: null,
                    confirmText: 'Yes',
                    cancelText: 'No',
                    isDestructive: false
                });
            };

            const fetchBoard = async () => {
                try {
                    console.log('Fetching boards from:', `${API_BASE}/boards`);
                    const response = await fetch(`${API_BASE}/boards`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const boards = await response.json();
                    console.log('Boards received:', boards);

                    if (boards.length > 0) {
                        console.log('Fetching board data for board ID:', boards[0].id);
                        const boardResponse = await fetch(`${API_BASE}/boards/${boards[0].id}`);

                        if (!boardResponse.ok) {
                            throw new Error(`HTTP error! status: ${boardResponse.status}`);
                        }

                        const boardData = await boardResponse.json();
                        console.log('Board data received:', boardData);
                        setBoard(boardData);
                    } else {
                        console.log('No boards found');
                        setError('No s\'ha trobat cap tauler');
                    }
                    setLoading(false);
                } catch (err) {
                    console.error('Error fetching board:', err);
                    setError(`No s'ha pogut carregar el tauler: ${err.message}`);
                    setLoading(false);
                }
            };

            const addList = async (title) => {
                try {
                    const response = await fetch(`${API_BASE}/lists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ board_id: board.id, title })
                    });
                    const newList = await response.json();
                    setBoard(prev => ({
                        ...prev,
                        lists: [...prev.lists, newList]
                    }));
                    setShowAddList(false);
                } catch (err) {
                    setError('Failed to add list');
                }
            };

            const updateList = async (listId, title) => {
                try {
                    await fetch(`${API_BASE}/lists/${listId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title })
                    });

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list =>
                            list.id === listId ? { ...list, title } : list
                        )
                    }));
                    setEditingList(null);
                } catch (err) {
                    setError('Failed to update list');
                }
            };

            const addCard = async (listId, title, description, dueDate, priority, clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands) => {
                try {
                    console.log('Adding card with all fields:', {
                        listId, title, description, dueDate, priority,
                        clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands
                    }); const response = await fetch(`${API_BASE}/cards`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            list_id: listId,
                            title,
                            description,
                            priority,
                            client_id: clientId,
                            worker_id: workerId,
                            head_equip_id: headEquipId,
                            start_datetime: startDatetime,
                            vehicle_number: vehicleNumber,
                            commands
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to add card');
                    }

                    const newCard = await response.json();
                    console.log('Received card from API:', newCard);

                    const cardWithAllFields = {
                        ...newCard,
                        priority: newCard.priority || priority
                    };

                    setBoard(prev => ({
                        ...prev,
                        lists: prev.lists.map(list =>
                            list.id === listId
                                ? { ...list, cards: [...list.cards, cardWithAllFields] }
                                : list
                        )
                    }));

                    // Close the appropriate modal based on which one is open
                    setShowAddCard(null);

                } catch (err) {
                    console.error('Error adding card:', err);
                    setError('Failed to add card');
                }
            }; const updateCard = async (cardId, title, description, priority, clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands, newListId = null) => {
                try {
                    console.log('Updating card with data:', {
                        cardId, title, description, priority, clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands, newListId
                    });

                    const response = await fetch(`${API_BASE}/cards/${cardId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title,
                            description,
                            priority,
                            client_id: clientId,
                            worker_id: workerId,
                            head_equip_id: headEquipId,
                            start_datetime: startDatetime,
                            vehicle_number: vehicleNumber,
                            commands
                        })
                    });

                    console.log('Update response status:', response.status);
                    console.log('Update response ok:', response.ok);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Update response error:', errorText);
                        throw new Error(`Failed to update card: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('Update response data:', result);

                    // If the list has changed, move the card to the new list
                    if (newListId && newListId !== board.lists.find(list => list.cards.some(card => card.id === cardId))?.id) {
                        console.log('Moving card to new list:', newListId);
                        await moveCard(cardId, newListId, 0); // Move to the top of the new list
                    }

                    // Refresh the board to get updated card with client/worker names
                    if (board && board.id) {
                        fetchBoard();
                    }
                    setEditingCard(null);
                } catch (err) {
                    console.error('Error updating card:', err);
                    setError('Error en actualitzar la targeta');
                }
            };

            const updateCardInBoard = (cardId, updates) => {
                setBoard(prev => ({
                    ...prev,
                    lists: prev.lists.map(list => ({
                        ...list,
                        cards: list.cards.map(card =>
                            card.id === cardId
                                ? { ...card, ...updates }
                                : card
                        )
                    }))
                }));
            };

            const deleteCard = async (cardId) => {
                const card = board.lists.flatMap(list => list.cards).find(c => c.id === cardId);

                showConfirmation({
                    title: 'Eliminar Targeta',
                    message: `Esteu segur que voleu eliminar "${card?.title}"?\nAquesta acciÃ³ no es pot desfer.`,
                    confirmText: 'Eliminar Targeta',
                    cancelText: 'CancelÂ·lar',
                    isDestructive: true,
                    onConfirm: async () => {
                        try {
                            await fetch(`${API_BASE}/cards/${cardId}`, {
                                method: 'DELETE'
                            });

                            setBoard(prev => ({
                                ...prev,
                                lists: prev.lists.map(list => ({
                                    ...list,
                                    cards: list.cards.filter(card => card.id !== cardId)
                                }))
                            }));
                            setEditingCard(null);
                        } catch (err) {
                            setError('Error en eliminar la targeta');
                        }
                    }
                });
            };

            const deleteList = async (listId) => {
                const list = board.lists.find(l => l.id === listId);
                const cardCount = list?.cards?.length || 0;

                showConfirmation({
                    title: 'Eliminar Llista',
                    message: `Esteu segur que voleu eliminar "${list?.title}"?${cardCount > 0 ? `\nAixÃ² tambÃ© eliminarÃ  ${cardCount} targeta${cardCount === 1 ? '' : 's'}.` : ''}\nAquesta acciÃ³ no es pot desfer.`,
                    confirmText: 'Eliminar Llista',
                    cancelText: 'CancelÂ·lar',
                    isDestructive: true,
                    onConfirm: async () => {
                        try {
                            await fetch(`${API_BASE}/lists/${listId}`, {
                                method: 'DELETE'
                            });

                            setBoard(prev => ({
                                ...prev,
                                lists: prev.lists.filter(list => list.id !== listId)
                            }));
                        } catch (err) {
                            setError('Error en eliminar la llista');
                        }
                    }
                });
            };

            const handleDragStart = (e, card) => {
                e.stopPropagation();
                setDraggedCard(card);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = (e) => {
                e.stopPropagation();
                e.target.classList.remove('dragging');
                setDraggedCard(null);
                setDraggedList(null);
                setDragOverList(null);
                setDragOverCard(null);
            };

            const handleListDragStart = (e, list) => {
                setDraggedList(list);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleListDragEnd = (e) => {
                e.target.classList.remove('dragging');
                setDraggedList(null);
                setDragOverList(null);
            };

            const handleListDragOver = (e, listId) => {
                e.preventDefault();
                e.stopPropagation();

                if (draggedList && draggedList.id !== listId) {
                    e.dataTransfer.dropEffect = 'move';
                    setDragOverList(listId);
                    return;
                }

                if (draggedCard) {
                    e.dataTransfer.dropEffect = 'move';
                    setDragOverList(listId);
                }
            };

            const handleListDragLeave = (e) => {
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    setDragOverList(null);
                }
            };

            const handleCardDragOver = (e, card) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                setDragOverCard(card.id);
            };

            const handleCardDragLeave = (e) => {
                e.stopPropagation();
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    setDragOverCard(null);
                }
            };

            const handleListDrop = async (e, targetListId) => {
                e.preventDefault();
                e.stopPropagation();

                if (draggedList && draggedList.id !== targetListId) {
                    await reorderList(draggedList.id, targetListId);
                    setDragOverList(null);
                    return;
                }

                if (draggedCard && draggedCard.list_id !== targetListId) {
                    await moveCard(draggedCard.id, targetListId, 0);
                }

                setDragOverList(null);
                setDragOverCard(null);
            };

            const handleBoardDragOver = (e) => {
                if (draggedList) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                }
            };

            const handleBoardDrop = (e) => {
                e.preventDefault();
                if (draggedList) {
                    reorderList(draggedList.id, null);
                }
            };

            const reorderList = async (draggedListId, targetListId) => {
                try {
                    const currentLists = [...board.lists];
                    const draggedIndex = currentLists.findIndex(list => list.id === draggedListId);

                    if (draggedIndex === -1) return;

                    let targetIndex;

                    if (targetListId === null) {
                        targetIndex = currentLists.length - 1;
                    } else {
                        targetIndex = currentLists.findIndex(list => list.id === targetListId);
                        if (targetIndex === -1) return;
                    }

                    const [draggedListItem] = currentLists.splice(draggedIndex, 1);
                    currentLists.splice(targetIndex, 0, draggedListItem);

                    const updatedLists = currentLists.map((list, index) => ({
                        ...list,
                        position: index
                    }));

                    setBoard(prev => ({
                        ...prev,
                        lists: updatedLists
                    }));

                    await fetch(`${API_BASE}/lists/${draggedListId}/reorder`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ position: targetIndex })
                    });

                } catch (err) {
                    setError('Failed to reorder list');
                    fetchBoard();
                }
            };

            const handleCardDrop = async (e, targetCard) => {
                e.preventDefault();
                e.stopPropagation();
                setDragOverList(null);
                setDragOverCard(null);

                if (!draggedCard || draggedCard.id === targetCard.id) return;

                const rect = e.currentTarget.getBoundingClientRect();
                const dropY = e.clientY;
                const cardMiddle = rect.top + rect.height / 2;
                const isDroppedAfter = dropY > cardMiddle;

                const targetList = board.lists.find(list => list.id === targetCard.list_id);
                const targetIndex = targetList.cards.findIndex(card => card.id === targetCard.id);
                const newPosition = isDroppedAfter ? targetIndex + 1 : targetIndex;

                await moveCard(draggedCard.id, targetCard.list_id, newPosition);
            };

            const moveCard = async (cardId, targetListId, position) => {
                try {
                    await fetch(`${API_BASE}/cards/${cardId}/move`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            list_id: targetListId,
                            position: position
                        })
                    });

                    setBoard(prev => {
                        const newBoard = { ...prev };
                        let movedCard = null;

                        newBoard.lists = newBoard.lists.map(list => {
                            if (list.cards.some(card => card.id === cardId)) {
                                movedCard = list.cards.find(card => card.id === cardId);
                                return {
                                    ...list,
                                    cards: list.cards.filter(card => card.id !== cardId)
                                };
                            }
                            return list;
                        });

                        newBoard.lists = newBoard.lists.map(list => {
                            if (list.id === targetListId) {
                                const newCards = [...list.cards];
                                const updatedCard = { ...movedCard, list_id: targetListId };
                                newCards.splice(position, 0, updatedCard);
                                return { ...list, cards: newCards };
                            }
                            return list;
                        });

                        return newBoard;
                    });
                } catch (err) {
                    setError('Failed to move card');
                }
            };

            // Filter function for cards
            const filterCards = (cards) => {
                return cards.filter(card => {
                    // Search filter - advanced matching
                    if (filters.search && filters.search.trim()) {
                        const searchTermLower = filters.search.toLowerCase().trim();
                        const searchWords = searchTermLower.split(/\s+/); // Split by whitespace

                        const searchableText = [
                            card.title || '',
                            card.description || ''
                        ].join(' ').toLowerCase().trim();

                        // Check if all search words are found in the searchable text
                        const searchMatch = searchWords.every(word =>
                            searchableText.includes(word)
                        );

                        if (!searchMatch) return false;
                    }

                    // Priority filter
                    if (filters.priority !== 'all' && (card.priority || 'medium') !== filters.priority) {
                        return false;
                    }                // Due date filter (using start_datetime)
                    if (filters.dueDate !== 'all') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (filters.dueDate === 'overdue') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            return startDate < today;
                        } else if (filters.dueDate === 'today') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            return startDate.getTime() === today.getTime();
                        } else if (filters.dueDate === 'upcoming') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                            return startDate > today && startDate <= weekFromNow;
                        } else if (filters.dueDate === 'no-date') {
                            return !card.start_datetime;
                        }
                    }

                    return true;
                });
            };

            // Filter lists for board view
            const filterLists = (lists) => {
                return lists.map(list => ({
                    ...list,
                    cards: filterCards(list.cards)
                }));
            };

            const clearFilters = () => {
                setFilters({
                    search: '',
                    priority: 'all',
                    dueDate: 'all'
                });
            };

            const hasActiveFilters = () => {
                return filters.search !== '' || filters.priority !== 'all' || filters.dueDate !== 'all';
            };

            // Get total filtered cards count
            const getFilteredCardsCount = () => {
                if (!board) return 0;
                const allCards = board.lists.flatMap(list => list.cards);
                return filterCards(allCards).length;
            };

            if (loading) return <div className="loading">Carregant el vostre tauler Kanban...</div>;
            if (error) return <div className="error">{error}</div>;
            if (!board) return <div className="loading">No s'ha trobat cap tauler</div>;

            return (
                <div className="app">
                    <div className="header">
                        <h1>Tauler Kanban</h1>
                    </div>

                    <div className="action-bar">
                        <div className="actions-dropdown-container">
                            <button
                                className={`actions-dropdown-button ${showActionsDropdown ? 'active' : ''}`}
                                onClick={() => setShowActionsDropdown(!showActionsDropdown)}
                            >
                                <i className="fas fa-plus"></i>
                                Accions
                                <i className={`fas fa-chevron-${showActionsDropdown ? 'up' : 'down'}`}></i>
                            </button>
                            {showActionsDropdown && (
                                <div className="actions-dropdown-menu">
                                    <button
                                        className="dropdown-item"
                                        onClick={() => {
                                            setShowAddList(true);
                                            setShowActionsDropdown(false);
                                        }}
                                    >
                                        <i className="fas fa-list"></i>
                                        Afegir Llista
                                    </button>
                                    <div className="dropdown-divider"></div>
                                    <button
                                        className="dropdown-item"
                                        onClick={() => {
                                            setCurrentView('clients');
                                            setShowActionsDropdown(false);
                                        }}
                                    >
                                        <i className="fas fa-users"></i>
                                        GestiÃ³ de Clients
                                    </button>
                                    <button
                                        className="dropdown-item"
                                        onClick={() => {
                                            setCurrentView('workers');
                                            setShowActionsDropdown(false);
                                        }}
                                    >
                                        <i className="fas fa-user-tie"></i>
                                        GestiÃ³ de Treballadors
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="action-bar-right">
                            {(currentView === 'board' || currentView === 'calendar') && (
                                <button
                                    className={`filter-toggle-button ${showFilters ? 'active' : ''}`}
                                    onClick={toggleFilters}
                                >
                                    <i className={`fas ${showFilters ? 'fa-filter-circle-xmark' : 'fa-filter'}`}></i>
                                </button>
                            )}
                            <div className="views">
                                <button
                                    className={currentView === 'board' ? 'active' : ''}
                                    onClick={() => setCurrentView('board')}
                                    title="Tauler Kanban"
                                >
                                    <i className="fa-solid fa-chart-simple fa-flip-both"></i>
                                </button>
                                <button
                                    className={currentView === 'calendar' ? 'active' : ''}
                                    onClick={() => setCurrentView('calendar')}
                                    title="Vista Calendari"
                                >
                                    <i className="fas fa-calendar"></i>
                                </button>
                            </div>
                            <button
                                className="theme-toggle-button"
                                onClick={toggleTheme}
                                title={`Canviar a mode ${theme === 'light' ? 'fosc' : 'clar'}`}
                            >
                                <i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'}`}></i>
                            </button>
                        </div>
                    </div>

                    {showFilters && (currentView === 'board' || currentView === 'calendar') && (
                        <FilterBar
                            filters={filters}
                            onFiltersChange={setFilters}
                            onClearFilters={clearFilters}
                            hasActiveFilters={hasActiveFilters()}
                            filteredCount={getFilteredCardsCount()}
                            totalCount={board.lists.flatMap(list => list.cards).length}
                        />
                    )}

                    {currentView === 'calendar' && (
                        <CalendarView
                            board={board}
                            filters={filters}
                            onEditCard={(card) => setEditingCard(card)}
                            onAddCard={addCard}
                            onUpdateCard={updateCardInBoard}
                        />
                    )}

                    {currentView === 'clients' && (
                        <ClientsView />
                    )}

                    {currentView === 'workers' && (
                        <WorkersView />
                    )}

                    {currentView === 'board' && (
                        <div
                            className="board"
                            onDragOver={handleBoardDragOver}
                            onDrop={handleBoardDrop}
                        >
                            {filterLists(board.lists).map(list => (
                                <div
                                    key={list.id}
                                    className={`list ${dragOverList === list.id ? 'drag-over' : ''} ${draggedList && draggedList.id === list.id ? 'dragging' : ''}`}
                                    draggable
                                    onDragStart={(e) => handleListDragStart(e, list)}
                                    onDragEnd={handleListDragEnd}
                                    onDragOver={(e) => handleListDragOver(e, list.id)}
                                    onDragLeave={handleListDragLeave}
                                    onDrop={(e) => handleListDrop(e, list.id)}
                                >
                                    <div className="list-header">
                                        <div className="list-drag-handle">
                                            <i className="fas fa-grip-vertical"></i>
                                        </div>
                                        {editingList === list.id ? (
                                            <EditListTitle
                                                list={list}
                                                onSave={updateList}
                                                onCancel={() => setEditingList(null)}
                                            />
                                        ) : (
                                            <h3
                                                className="list-title"
                                                onDoubleClick={() => setEditingList(list.id)}
                                            >
                                                {list.title}
                                            </h3>
                                        )}
                                        <button
                                            className="delete-button"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                deleteList(list.id);
                                            }}
                                        >
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </div>

                                    <div className="list-content">
                                        {list.cards.map(card => (
                                            <div
                                                key={card.id}
                                                className={`card ${dragOverCard === card.id ? 'drag-over' : ''} priority-${card.priority || 'medium'}`}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, card)}
                                                onDragEnd={handleDragEnd}
                                                onDragOver={(e) => handleCardDragOver(e, card)}
                                                onDragLeave={handleCardDragLeave}
                                                onDrop={(e) => handleCardDrop(e, card)}
                                                onClick={(e) => {
                                                    if (!draggedCard) {
                                                        setEditingCard(card);
                                                    }
                                                }}
                                            >
                                                <div className="card-title">{card.title}</div>
                                                {card.description && (
                                                    <div className="card-description">{card.description}</div>
                                                )}                                            <div className="card-meta">
                                                    {card.start_datetime && (
                                                        <div className={`card-due-date ${(() => {
                                                            const today = new Date();
                                                            today.setHours(0, 0, 0, 0);

                                                            // Parse the start_datetime
                                                            const startDate = new Date(card.start_datetime);
                                                            startDate.setHours(0, 0, 0, 0);

                                                            return startDate < today ? 'overdue' : '';
                                                        })()}`}>
                                                            <i className="fas fa-calendar"></i>
                                                            {formatDateTimeForDisplay(card.start_datetime)}
                                                        </div>
                                                    )}                                            <div className={`card-priority priority-${card.priority || 'medium'}`}>
                                                        <i className="fas fa-flag"></i>
                                                        {(card.priority || 'medium').charAt(0).toUpperCase() + (card.priority || 'medium').slice(1)}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <button
                                        className="add-button"
                                        onClick={() => setShowAddCard(list.id)}
                                    >
                                        <i className="fas fa-plus"></i>
                                        Afegir Targeta
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {showAddList && (
                        <AddListModal
                            onSave={addList}
                            onClose={() => setShowAddList(false)}
                        />
                    )}

                    {showAddCard && (
                        <AddCardModal
                            board={board}
                            defaultListId={showAddCard}
                            showListSelection={false}
                            onSave={(listId, title, description, dueDate, priority, clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands) =>
                                addCard(listId, title, description, dueDate, priority, clientId, workerId, headEquipId, startDatetime, vehicleNumber, commands)
                            }
                            onClose={() => setShowAddCard(null)}
                        />
                    )}

                    {editingCard && (
                        <EditCardModal
                            card={editingCard}
                            board={board}
                            onSave={updateCard}
                            onDelete={deleteCard}
                            onClose={() => setEditingCard(null)}
                        />
                    )}
                    <ConfirmationModal
                        isOpen={confirmation.isOpen}
                        title={confirmation.title}
                        message={confirmation.message}
                        onConfirm={confirmation.onConfirm}
                        onCancel={hideConfirmation}
                        confirmText={confirmation.confirmText}
                        cancelText={confirmation.cancelText}
                        isDestructive={confirmation.isDestructive}
                    />
                </div>
            );
        }

        function ClientsView() {
            const [allClients, setAllClients] = useState([]); // Store all clients
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingClient, setEditingClient] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');

            // Initial fetch - only once
            useEffect(() => {
                fetchAllClients();
            }, []);

            // Client-side filtering - instant results
            const filteredClients = allClients.filter(client => {
                // Search filter - advanced matching
                if (!searchTerm || !searchTerm.trim()) return true;

                const searchTermLower = searchTerm.toLowerCase().trim();
                const searchWords = searchTermLower.split(/\s+/); // Split by whitespace

                const searchableText = [
                    client.name || '',
                    client.email || '',
                    client.company || ''
                ].join(' ').toLowerCase().trim();

                // Check if all search words are found in the searchable text
                const searchMatch = searchWords.every(word =>
                    searchableText.includes(word)
                );

                // Status filter
                const statusMatch = statusFilter === 'all' || client.status === statusFilter;

                return searchMatch && statusMatch;
            });

            const fetchAllClients = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE}/clients`);
                    if (!response.ok) throw new Error('Error carregant clients');
                    const data = await response.json();
                    setAllClients(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddClient = async (clientData) => {
                try {
                    const response = await fetch(`${API_BASE}/clients`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clientData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error creant client');
                    }
                    setShowAddModal(false);
                    fetchAllClients(); // Refresh all clients
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleEditClient = async (clientData) => {
                try {
                    const response = await fetch(`${API_BASE}/clients/${editingClient.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clientData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error actualitzant client');
                    }
                    setEditingClient(null);
                    fetchAllClients(); // Refresh all clients
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleDeleteClient = async (clientId) => {
                if (confirm('Esteu segur que voleu eliminar aquest client?')) {
                    try {
                        const response = await fetch(`${API_BASE}/clients/${clientId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Error eliminant client');
                        fetchAllClients(); // Refresh all clients
                    } catch (err) {
                        alert(err.message);
                    }
                }
            };

            if (loading) return <div className="loading">Carregant clients...</div>;
            if (error) return <div className="error">Error: {error}</div>;

            return (
                <div className="crud-view">
                    <div className="crud-header">
                        <h2><i className="fas fa-users"></i> GestiÃ³ de Clients</h2>
                        <button className="crud-add-button" onClick={() => setShowAddModal(true)}>
                            <i className="fas fa-plus"></i> Afegir Client
                        </button>
                    </div>

                    <div className="crud-filters">
                        <div className="filter-item">
                            <i className="fas fa-search"></i>
                            <input
                                type="text"
                                placeholder="Cercar clients..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="filter-input"
                            />
                        </div>
                        <div className="filter-item">
                            <i className="fas fa-filter"></i>
                            <select
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="filter-select"
                            >
                                <option value="all">Tots els estats</option>
                                <option value="active">Actiu</option>
                                <option value="inactive">Inactiu</option>
                                <option value="prospect">Prospector</option>
                            </select>
                        </div>
                    </div>

                    <div className="crud-table-container">
                        <table className="crud-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>TelÃ¨fon</th>
                                    <th>Empresa</th>
                                    <th>AdreÃ§a</th>
                                    <th>Estat</th>
                                    <th>Accions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredClients.map(client => (
                                    <tr key={client.id}>
                                        <td>{client.name}</td>
                                        <td>{client.email || '-'}</td>
                                        <td>{client.phone || '-'}</td>
                                        <td>{client.company || '-'}</td>
                                        <td>{client.address || '-'}</td>
                                        <td>
                                            <span className={`status-badge status-${client.status}`}>
                                                {client.status === 'active' ? 'Actiu' :
                                                    client.status === 'inactive' ? 'Inactiu' : 'Prospector'}
                                            </span>
                                        </td>
                                        <td className="actions">
                                            <button
                                                onClick={() => setEditingClient(client)}
                                                className="edit-button"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteClient(client.id)}
                                                className="delete-button"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredClients.length === 0 && !loading && (
                            <div className="empty-state">
                                <i className="fas fa-users"></i>
                                <p>No s'han trobat clients</p>
                            </div>
                        )}
                    </div>

                    {showAddModal && (
                        <ClientModal
                            onSave={handleAddClient}
                            onClose={() => setShowAddModal(false)}
                        />
                    )}

                    {editingClient && (
                        <ClientModal
                            client={editingClient}
                            onSave={handleEditClient}
                            onClose={() => setEditingClient(null)}
                        />
                    )}
                </div>
            );
        }

        function WorkersView() {
            const [allWorkers, setAllWorkers] = useState([]); // Store all workers
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingWorker, setEditingWorker] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [departmentFilter, setDepartmentFilter] = useState('all');
            const [departments, setDepartments] = useState([]);

            // Initial fetch - only once
            useEffect(() => {
                fetchAllWorkers();
                fetchDepartments();
            }, []);

            // Client-side filtering - instant results
            const filteredWorkers = allWorkers.filter(worker => {
                // Search filter - advanced matching
                if (!searchTerm || !searchTerm.trim()) return true;

                const searchTermLower = searchTerm.toLowerCase().trim();
                const searchWords = searchTermLower.split(/\s+/); // Split by whitespace

                const searchableText = [
                    worker.name || '',
                    worker.email || '',
                    worker.position || ''
                ].join(' ').toLowerCase().trim();

                // Check if all search words are found in the searchable text
                const searchMatch = searchWords.every(word =>
                    searchableText.includes(word)
                );

                // Department filter
                const departmentMatch = departmentFilter === 'all' || worker.department === departmentFilter;

                return searchMatch && departmentMatch;
            });

            const fetchAllWorkers = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE}/workers`);
                    if (!response.ok) throw new Error('Error carregant treballadors');
                    const data = await response.json();
                    setAllWorkers(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const fetchDepartments = async () => {
                try {
                    const response = await fetch(`${API_BASE}/departments`);
                    if (response.ok) {
                        const data = await response.json();
                        setDepartments(data);
                    }
                } catch (err) {
                    console.error('Error fetching departments:', err);
                }
            };

            const handleAddWorker = async (workerData) => {
                try {
                    const response = await fetch(`${API_BASE}/workers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(workerData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error creant treballador');
                    }
                    setShowAddModal(false);
                    fetchAllWorkers();
                    fetchDepartments(); // Refresh departments
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleEditWorker = async (workerData) => {
                try {
                    const response = await fetch(`${API_BASE}/workers/${editingWorker.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(workerData)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error actualitzant treballador');
                    }
                    setEditingWorker(null);
                    fetchAllWorkers();
                    fetchDepartments(); // Refresh departments
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleDeleteWorker = async (workerId) => {
                if (confirm('Esteu segur que voleu eliminar aquest treballador?')) {
                    try {
                        const response = await fetch(`${API_BASE}/workers/${workerId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Error eliminant treballador');
                        fetchAllWorkers();
                        fetchDepartments(); // Refresh departments
                    } catch (err) {
                        alert(err.message);
                    }
                }
            };

            if (loading) return <div className="loading">Carregant treballadors...</div>;
            if (error) return <div className="error">Error: {error}</div>;

            return (
                <div className="crud-view">
                    <div className="crud-header">
                        <h2><i className="fas fa-user-tie"></i> GestiÃ³ de Treballadors</h2>
                        <button className="crud-add-button" onClick={() => setShowAddModal(true)}>
                            <i className="fas fa-plus"></i> Afegir Treballador
                        </button>
                    </div>

                    <div className="crud-filters">
                        <div className="filter-item">
                            <i className="fas fa-search"></i>
                            <input
                                type="text"
                                placeholder="Cercar treballadors..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="filter-input"
                            />
                        </div>
                        <div className="filter-item">
                            <i className="fas fa-building"></i>
                            <select
                                value={departmentFilter}
                                onChange={(e) => setDepartmentFilter(e.target.value)}
                                className="filter-select"
                            >
                                <option value="all">Tots els departaments</option>
                                {departments.map(dept => (
                                    <option key={dept} value={dept}>{dept}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="crud-table-container">
                        <table className="crud-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>TelÃ¨fon</th>
                                    <th>PosiciÃ³</th>
                                    <th>Departament</th>
                                    <th>AdreÃ§a</th>
                                    <th>Accions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredWorkers.map(worker => (
                                    <tr key={worker.id}>
                                        <td>{worker.name}</td>
                                        <td>{worker.email || '-'}</td>
                                        <td>{worker.phone || '-'}</td>
                                        <td>{worker.position || '-'}</td>
                                        <td>{worker.department || '-'}</td>
                                        <td>{worker.address || '-'}</td>
                                        <td className="actions">
                                            <button
                                                onClick={() => setEditingWorker(worker)}
                                                className="edit-button"
                                                title="Editar"
                                            >
                                                <i className="fas fa-edit"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteWorker(worker.id)}
                                                className="delete-button"
                                                title="Eliminar"
                                            >
                                                <i className="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredWorkers.length === 0 && !loading && (
                            <div className="empty-state">
                                <i className="fas fa-user-tie"></i>
                                <p>No s'han trobat treballadors</p>
                            </div>
                        )}
                    </div>

                    {showAddModal && (
                        <WorkerModal
                            onSave={handleAddWorker}
                            onClose={() => setShowAddModal(false)}
                        />
                    )}

                    {editingWorker && (
                        <WorkerModal
                            worker={editingWorker}
                            onSave={handleEditWorker}
                            onClose={() => setEditingWorker(null)}
                        />
                    )}
                </div>
            );
        }

        function FilterBar({ filters, onFiltersChange, onClearFilters, hasActiveFilters, filteredCount, totalCount }) {
            const updateFilter = (key, value) => {
                onFiltersChange(prev => ({
                    ...prev,
                    [key]: value
                }));
            };

            return (
                <div className="filter-bar">
                    <div className="filter-group">
                        <div className="filter-item">
                            <i className="fas fa-search"></i>
                            <input
                                type="text"
                                placeholder="Cercar targetes..."
                                value={filters.search}
                                onChange={(e) => updateFilter('search', e.target.value)}
                                className="filter-input"
                            />
                        </div>

                        <div className="filter-item">
                            <i className="fas fa-flag"></i>
                            <select
                                value={filters.priority}
                                onChange={(e) => updateFilter('priority', e.target.value)}
                                className="filter-select"
                            >
                                <option value="all">Totes les Prioritats</option>
                                <option value="low">Prioritat Baixa</option>
                                <option value="medium">Prioritat Mitjana</option>
                                <option value="high">Prioritat Alta</option>
                                <option value="urgent">Prioritat Urgent</option>
                            </select>
                        </div>

                        <div className="filter-item">
                            <i className="fas fa-calendar"></i>
                            <select
                                value={filters.dueDate}
                                onChange={(e) => updateFilter('dueDate', e.target.value)}
                                className="filter-select"
                            >
                                <option value="all">Totes les Dates LÃ­mit</option>
                                <option value="overdue">VenÃ§udes</option>
                                <option value="today">Vencen Avui</option>
                                <option value="upcoming">Vencen Aquesta Setmana</option>
                                <option value="no-date">Sense Data LÃ­mit</option>
                            </select>
                        </div>

                        <div className="filter-status">
                            {hasActiveFilters && (
                                <div className="filtered-count">
                                    <i className="fas fa-filter"></i>
                                    {filteredCount} de {totalCount} targetes
                                </div>
                            )}

                            {hasActiveFilters && (
                                <div className="filter-indicator">
                                    <i className="fas fa-check-circle"></i>
                                    Filtres Actius
                                </div>
                            )}
                        </div>

                        {hasActiveFilters && (
                            <button
                                className="clear-filters-button"
                                onClick={onClearFilters}
                                title="Netejar tots els filtres"
                            >
                                <i className="fas fa-times"></i>
                                Netejar Filtres
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function CalendarView({ board, filters, onEditCard, onAddCard, onUpdateCard }) {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [showGoToDate, setShowGoToDate] = useState(false);
            const [goToDateValue, setGoToDateValue] = useState('');
            const [showAddTaskModal, setShowAddTaskModal] = useState(false);
            const [selectedDateForTask, setSelectedDateForTask] = useState(null);
            const [highlightedDate, setHighlightedDate] = useState(null);
            const [draggedCard, setDraggedCard] = useState(null);
            const [dragOverDate, setDragOverDate] = useState(null);
            const [isDragging, setIsDragging] = useState(false);

            // Get all cards with due dates and apply filters
            const getAllCards = () => {
                const allCards = board.lists.flatMap(list =>
                    list.cards.map(card => ({
                        ...card,
                        listName: list.title
                    }))
                );

                // Apply filters
                return allCards.filter(card => {
                    // Search filter
                    if (filters.search && !card.title.toLowerCase().includes(filters.search.toLowerCase()) &&
                        !card.description?.toLowerCase().includes(filters.search.toLowerCase())) {
                        return false;
                    }

                    // Priority filter
                    if (filters.priority !== 'all' && (card.priority || 'medium') !== filters.priority) {
                        return false;
                    }                // Due date filter for calendar view (using start_datetime)
                    if (filters.dueDate !== 'all') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (filters.dueDate === 'overdue') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            return startDate < today;
                        } else if (filters.dueDate === 'today') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            return startDate.getTime() === today.getTime();
                        } else if (filters.dueDate === 'upcoming') {
                            if (!card.start_datetime) return false;
                            const startDate = new Date(card.start_datetime);
                            startDate.setHours(0, 0, 0, 0);
                            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                            return startDate > today && startDate <= weekFromNow;
                        } else if (filters.dueDate === 'no-date') {
                            return !card.start_datetime;
                        }
                    }

                    return true;
                });
            };

            // Get cards for a specific date - now uses filtered cards
            const getCardsForDate = (date) => {
                // Use the same date formatting logic
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`; const cardsForDate = getAllCards().filter(card => {
                    if (!card.start_datetime) return false;
                    // Extract just the date part from start_datetime
                    const cardDateStr = card.start_datetime.includes('T')
                        ? card.start_datetime.split('T')[0]
                        : card.start_datetime.split(' ')[0]; // Handle 'YYYY-MM-DD HH:mm:ss' format too
                    return cardDateStr === dateStr;
                });

                // Sort cards by time
                return cardsForDate.sort((a, b) => {
                    // Extract time from start_datetime
                    const getTimeFromDateTime = (dateTimeStr) => {
                        if (!dateTimeStr) return '00:00'; // Default time for cards without time

                        let timeStr;
                        if (dateTimeStr.includes('T')) {
                            // ISO format: YYYY-MM-DDTHH:mm:ss or YYYY-MM-DDTHH:mm
                            timeStr = dateTimeStr.split('T')[1];
                            if (timeStr.includes('.')) {
                                timeStr = timeStr.split('.')[0]; // Remove milliseconds
                            }
                            if (timeStr.includes('+') || timeStr.includes('Z')) {
                                timeStr = timeStr.replace(/[+Z].*$/, ''); // Remove timezone info
                            }
                        } else if (dateTimeStr.includes(' ')) {
                            // MySQL format: YYYY-MM-DD HH:mm:ss
                            timeStr = dateTimeStr.split(' ')[1];
                        } else {
                            return '00:00'; // No time component
                        }

                        // Return just HH:mm for comparison
                        return timeStr.substring(0, 5);
                    };

                    const timeA = getTimeFromDateTime(a.start_datetime);
                    const timeB = getTimeFromDateTime(b.start_datetime);

                    return timeA.localeCompare(timeB);
                });
            };

            // Generate calendar days
            const generateCalendarDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                const days = [];

                // Add empty cells for days before the first day of the month
                for (let i = 0; i < startingDayOfWeek; i++) {
                    days.push(null);
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const cards = getCardsForDate(date);
                    days.push({ date, cards });
                }

                return days;
            };

            const navigateMonth = (direction) => {
                setCurrentDate(prev => {
                    const newDate = new Date(prev);
                    newDate.setMonth(prev.getMonth() + direction);
                    return newDate;
                });
            }; const updateCardStartDateTime = async (cardId, newDate) => {
                try {
                    // Format the date as datetime for start_datetime
                    const year = newDate.getFullYear();
                    const month = String(newDate.getMonth() + 1).padStart(2, '0');
                    const day = String(newDate.getDate()).padStart(2, '0');
                    const newStartDateTime = `${year}-${month}-${day}T09:00:00`; // Default to 9 AM

                    const response = await fetch(`${API_BASE}/cards/${cardId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_datetime: newStartDateTime
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update card');
                    }

                    // Update the board state using the passed function
                    if (onUpdateCard) {
                        onUpdateCard(cardId, { start_datetime: newStartDateTime });
                    }
                } catch (error) {
                    console.error('Error updating card start datetime:', error);
                }
            };

            // Calendar card drag handlers
            const handleCardDragStart = (e, card) => {
                e.stopPropagation();
                setDraggedCard(card);
                setIsDragging(true); // Set dragging flag
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', ''); // Required for Firefox

                // Add visual feedback
                e.target.style.opacity = '0.5';
            };

            const handleCardDragEnd = (e) => {
                e.stopPropagation();
                setDraggedCard(null);
                setDragOverDate(null);

                // Reset visual feedback
                e.target.style.opacity = '1';

                // Reset dragging flag after a short delay to prevent click
                setTimeout(() => {
                    setIsDragging(false);
                }, 100);
            };

            const handleDateDragOver = (e, date) => {
                e.preventDefault();
                e.stopPropagation();

                if (draggedCard) {
                    e.dataTransfer.dropEffect = 'move';
                    setDragOverDate(date);
                }
            };

            const handleDateDragLeave = (e) => {
                e.stopPropagation();
                // Only clear drag over if we're actually leaving the date cell
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    setDragOverDate(null);
                }
            };

            const handleDateDrop = async (e, targetDate) => {
                e.preventDefault();
                e.stopPropagation();

                if (!draggedCard) return;            // Use the same date formatting logic as everywhere else
                const year = targetDate.getFullYear();
                const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                const day = String(targetDate.getDate()).padStart(2, '0');
                const newDateStr = `${year}-${month}-${day}`;

                console.log('Calendar drag drop - new date:', newDateStr); // Debug log

                // Check if the date is actually different from start_datetime
                let currentDateStr = null;
                if (draggedCard.start_datetime) {
                    currentDateStr = draggedCard.start_datetime.split('T')[0];
                }

                if (currentDateStr !== newDateStr) {
                    await updateCardStartDateTime(draggedCard.id, targetDate);
                }

                setDraggedCard(null);
                setDragOverDate(null);
            };

            // Handle card click - prevent when dragging
            const handleCardClick = (e, card) => {
                e.stopPropagation();
                // Only open edit modal if not dragging
                if (!isDragging) {
                    onEditCard(card);
                }
            };

            const goToDate = (dateString) => {
                if (!dateString) return;

                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return;

                setCurrentDate(date);
                setHighlightedDate(date); // Set the highlighted date
                setGoToDateValue('');
                setShowGoToDate(false);

                // Clear highlight after 3 seconds
                setTimeout(() => {
                    setHighlightedDate(null);
                }, 3000);
            };

            const goToToday = () => {
                setCurrentDate(new Date());
            };

            const handleDateClick = (date) => {
                setSelectedDate(date);
                setSelectedDateForTask(date);
                setShowAddTaskModal(true);
            };

            const formatDateForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const isToday = (date) => {
                const today = new Date();
                return date.getFullYear() === today.getFullYear() &&
                    date.getMonth() === today.getMonth() &&
                    date.getDate() === today.getDate();
            };

            const isHighlighted = (date) => {
                if (!highlightedDate) return false;
                return date.getFullYear() === highlightedDate.getFullYear() &&
                    date.getMonth() === highlightedDate.getMonth() &&
                    date.getDate() === highlightedDate.getDate();
            };

            const isDragOver = (date) => {
                if (!dragOverDate) return false;
                return date.getFullYear() === dragOverDate.getFullYear() &&
                    date.getMonth() === dragOverDate.getMonth() &&
                    date.getDate() === dragOverDate.getDate();
            };

            const isOverdue = (date) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const compareDate = new Date(date);
                compareDate.setHours(0, 0, 0, 0);

                return compareDate < today;
            };

            const monthNames = [
                'Gener', 'Febrer', 'MarÃ§', 'Abril', 'Maig', 'Juny',
                'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'
            ];

            const dayNames = ['Dg', 'Dl', 'Dt', 'Dc', 'Dj', 'Dv', 'Ds'];

            // Modified calendar rendering to show filter status
            return (
                <div className="calendar-view">
                    <div className="calendar-header">
                        <div className="calendar-nav-left">
                            <button
                                className="calendar-nav-button"
                                onClick={() => navigateMonth(-1)}
                            >
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <h2 className="calendar-title">
                                {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
                                {(filters.search || filters.priority !== 'all' || filters.dueDate !== 'all') && (
                                    <span className="filter-indicator">
                                        <i className="fas fa-filter"></i>
                                        Filtrat
                                    </span>
                                )}
                            </h2>
                            <button
                                className="calendar-nav-button"
                                onClick={() => navigateMonth(1)}
                            >
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div className="calendar-controls">
                            <button
                                className="calendar-control-button"
                                onClick={goToToday}
                                title="Anar a Avui"
                            >
                                <i className="fas fa-calendar-day"></i>
                                Avui
                            </button>

                            <div className="go-to-date-container">
                                {showGoToDate ? (
                                    <div className="go-to-date-input">
                                        <input
                                            type="date"
                                            value={goToDateValue}
                                            onChange={(e) => setGoToDateValue(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    goToDate(goToDateValue);
                                                } else if (e.key === 'Escape') {
                                                    setGoToDateValue('');
                                                    setShowGoToDate(false);
                                                }
                                            }}
                                            autoFocus
                                        />
                                        <button
                                            className="go-button"
                                            onClick={() => goToDate(goToDateValue)}
                                        >
                                            Anar
                                        </button>
                                        <button
                                            className="cancel-go-button"
                                            onClick={() => {
                                                setGoToDateValue('');
                                                setShowGoToDate(false);
                                            }}
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                ) : (
                                    <button
                                        className="calendar-control-button"
                                        onClick={() => setShowGoToDate(true)}
                                        title="Anar a Data EspecÃ­fica"
                                    >
                                        <i className="fas fa-search"></i>
                                        Anar a Data
                                    </button>
                                )}
                            </div>

                            <button
                                className="calendar-control-button add-task-button"
                                onClick={() => {
                                    setSelectedDateForTask(new Date());
                                    setShowAddTaskModal(true);
                                }}
                                title="Afegir Nova Tasca"
                            >
                                <i className="fas fa-plus"></i>
                                Afegir Tasca
                            </button>
                        </div>
                    </div>

                    <div className="calendar-grid">
                        {dayNames.map(day => (
                            <div key={day} className="calendar-day-header">
                                {day}
                            </div>
                        ))}

                        {generateCalendarDays().map((dayData, index) => (
                            <div
                                key={index}
                                className={`calendar-day ${dayData
                                    ? `${isToday(dayData.date) ? 'today' : ''} ${isHighlighted(dayData.date) ? 'highlighted' : ''} ${isDragOver(dayData.date) ? 'drag-over' : ''} ${dayData.cards.length > 0 ? 'has-cards' : ''} clickable`
                                    : 'empty'
                                    }`}
                                onClick={() => dayData && handleDateClick(dayData.date)}
                                onDragOver={(e) => dayData && handleDateDragOver(e, dayData.date)}
                                onDragLeave={handleDateDragLeave}
                                onDrop={(e) => dayData && handleDateDrop(e, dayData.date)}
                            >
                                {dayData && (
                                    <>
                                        <div className="calendar-day-number">
                                            {dayData.date.getDate()}
                                        </div>
                                        <div className="calendar-day-cards">
                                            {dayData.cards.map(card => (
                                                <div
                                                    key={card.id}
                                                    className={`calendar-card priority-${card.priority || 'medium'} ${isOverdue(dayData.date) ? 'overdue' : ''
                                                        } ${draggedCard && draggedCard.id === card.id ? 'dragging' : ''}`}
                                                    draggable
                                                    onDragStart={(e) => handleCardDragStart(e, card)}
                                                    onDragEnd={handleCardDragEnd}
                                                    onClick={(e) => handleCardClick(e, card)}
                                                    title={`${card.title} (${card.listName}) - Drag to move to another date`}
                                                >
                                                    <div className="calendar-card-title">{card.title}</div>
                                                    <div className="calendar-card-list">
                                                        {card.listName}
                                                        {card.start_datetime && (() => {
                                                            // Extract and format time
                                                            let timeStr = '';
                                                            if (card.start_datetime.includes('T')) {
                                                                timeStr = card.start_datetime.split('T')[1];
                                                                if (timeStr.includes('.')) {
                                                                    timeStr = timeStr.split('.')[0];
                                                                }
                                                                if (timeStr.includes('+') || timeStr.includes('Z')) {
                                                                    timeStr = timeStr.replace(/[+Z].*$/, '');
                                                                }
                                                            } else if (card.start_datetime.includes(' ')) {
                                                                timeStr = card.start_datetime.split(' ')[1];
                                                            }

                                                            if (timeStr && timeStr !== '00:00:00') {
                                                                return ` â¢ ${timeStr.substring(0, 5)}`;
                                                            }
                                                            return '';
                                                        })()}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="calendar-day-add">
                                            <button
                                                className="calendar-add-button"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDateClick(dayData.date);
                                                }}
                                                title="Add task for this date"
                                            >
                                                <i className="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>

                    {showAddTaskModal && (
                        <CalendarAddTaskModal
                            selectedDate={selectedDateForTask}
                            lists={board.lists}
                            onSave={onAddCard}
                            onClose={() => {
                                setShowAddTaskModal(false);
                                setSelectedDateForTask(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function ClientModal({ client, onSave, onClose }) {
            const [formData, setFormData] = useState({
                name: client?.name || '',
                email: client?.email || '',
                phone: client?.phone || '',
                company: client?.company || '',
                address: client?.address || '',
                status: client?.status || 'active',
                notes: client?.notes || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name.trim()) {
                    onSave(formData);
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const updateField = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>{client ? 'Editar Client' : 'Afegir Client'}</h3>
                        <form onSubmit={handleSubmit} className="modal-form">
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Nom *</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => updateField('name', e.target.value)}
                                        className="modal-input"
                                        required
                                        placeholder="Nom del client"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Email</label>
                                    <input
                                        type="email"
                                        value={formData.email}
                                        onChange={(e) => updateField('email', e.target.value)}
                                        className="modal-input"
                                        placeholder="correu@exemple.com"
                                    />
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>TelÃ¨fon</label>
                                    <input
                                        type="tel"
                                        value={formData.phone}
                                        onChange={(e) => updateField('phone', e.target.value)}
                                        className="modal-input"
                                        placeholder="+34 600 000 000"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Empresa</label>
                                    <input
                                        type="text"
                                        value={formData.company}
                                        onChange={(e) => updateField('company', e.target.value)}
                                        className="modal-input"
                                        placeholder="Nom de l'empresa"
                                    />
                                </div>
                            </div>
                            <div className="form-group">
                                <label>AdreÃ§a</label>
                                <input
                                    type="text"
                                    value={formData.address}
                                    onChange={(e) => updateField('address', e.target.value)}
                                    className="modal-input"
                                    placeholder="Carrer, nÃºmero, pis, ciutat, paÃ­s..."
                                />
                            </div>
                            <div className="form-group">
                                <label>Estat</label>
                                <select
                                    value={formData.status}
                                    onChange={(e) => updateField('status', e.target.value)}
                                    className="modal-select"
                                >
                                    <option value="active">Actiu</option>
                                    <option value="inactive">Inactiu</option>
                                    <option value="prospect">Prospector</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => updateField('notes', e.target.value)}
                                    className="modal-textarea"
                                    placeholder="Notes addicionals..."
                                    rows={3}
                                />
                            </div>
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fas fa-save"></i> {client ? 'Actualitzar' : 'Crear'}
                                </button>
                                <button type="button" onClick={onClose} className="cancel-button">
                                    <i className="fas fa-times"></i> CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function WorkerModal({ worker, onSave, onClose }) {
            const [formData, setFormData] = useState({
                name: worker?.name || '',
                email: worker?.email || '',
                phone: worker?.phone || '',
                position: worker?.position || '',
                department: worker?.department || '',
                address: worker?.address || '',
                notes: worker?.notes || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name.trim()) {
                    onSave(formData);
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const updateField = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>{worker ? 'Editar Treballador' : 'Afegir Treballador'}</h3>
                        <form onSubmit={handleSubmit} className="modal-form">
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Nom *</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => updateField('name', e.target.value)}
                                        className="modal-input"
                                        required
                                        placeholder="Nom del treballador"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Email</label>
                                    <input
                                        type="email"
                                        value={formData.email}
                                        onChange={(e) => updateField('email', e.target.value)}
                                        className="modal-input"
                                        placeholder="correu@exemple.com"
                                    />
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>TelÃ¨fon</label>
                                    <input
                                        type="tel"
                                        value={formData.phone}
                                        onChange={(e) => updateField('phone', e.target.value)}
                                        className="modal-input"
                                        placeholder="+34 600 000 000"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>PosiciÃ³</label>
                                    <input
                                        type="text"
                                        value={formData.position}
                                        onChange={(e) => updateField('position', e.target.value)}
                                        className="modal-input"
                                        placeholder="Desenvolupador, Gerent..."
                                    />
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Departament</label>
                                <input
                                    type="text"
                                    value={formData.department}
                                    onChange={(e) => updateField('department', e.target.value)}
                                    className="modal-input"
                                    placeholder="IT, Vendes, MÃ rqueting..."
                                />
                            </div>
                            <div className="form-group">
                                <label>AdreÃ§a</label>
                                <input
                                    type="text"
                                    value={formData.address}
                                    onChange={(e) => updateField('address', e.target.value)}
                                    className="modal-input"
                                    placeholder="Carrer, nÃºmero, pis, ciutat, paÃ­s..."
                                />
                            </div>
                            <div className="form-group">
                                <label>Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => updateField('notes', e.target.value)}
                                    className="modal-textarea"
                                    placeholder="Notes addicionals..."
                                    rows={3}
                                />
                            </div>
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fas fa-save"></i> {worker ? 'Actualitzar' : 'Crear'}
                                </button>
                                <button type="button" onClick={onClose} className="cancel-button">
                                    <i className="fas fa-times"></i> CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AddListModal({ onSave, onClose }) {
            const [title, setTitle] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    onSave(title.trim());
                    setTitle('');
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content">
                        <h3>Afegir Nova Llista</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="TÃ­tol de la llista"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                autoFocus
                                className="modal-input"
                            />
                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fa-solid fa-plus"></i>
                                    Afegir Llista
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditListTitle({ list, onSave, onCancel }) {
            const [title, setTitle] = useState(list.title);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim() && title.trim() !== list.title) {
                    onSave(list.id, title.trim());
                } else {
                    onCancel();
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit(e);
                } else if (e.key === 'Escape') {
                    onCancel();
                }
            };

            const handleBlur = () => {
                if (title.trim() && title.trim() !== list.title) {
                    onSave(list.id, title.trim());
                } else {
                    onCancel();
                }
            };

            return (
                <input
                    type="text"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    onKeyDown={handleKeyDown}
                    onBlur={handleBlur}
                    autoFocus
                    className="list-title-input"
                />
            );
        }

        function AddCardModal({ board, defaultListId, showListSelection = true, onSave, onClose }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [selectedListId, setSelectedListId] = useState(defaultListId || (board?.lists?.[0]?.id || ''));
            const [priority, setPriority] = useState('medium');
            const [clientId, setClientId] = useState('');
            const [clientSearch, setClientSearch] = useState('');
            const [clients, setClients] = useState([]);
            const [workerId, setWorkerId] = useState('');
            const [workerSearch, setWorkerSearch] = useState('');
            const [workers, setWorkers] = useState([]);
            const [headEquipId, setHeadEquipId] = useState('');
            const [headEquipSearch, setHeadEquipSearch] = useState('');
            const [headEquipList, setHeadEquipList] = useState([]);
            const [startDatetime, setStartDatetime] = useState('');
            const [vehicleNumber, setVehicleNumber] = useState('');
            const [commands, setCommands] = useState('');

            // Search for clients
            useEffect(() => {
                const searchClients = async () => {
                    if (!clientSearch.trim()) {
                        setClients([]);
                        return;
                    }
                    try {
                        console.log('Searching for clients with term:', clientSearch);
                        const response = await fetch(`${API_BASE}/clients/search?term=${encodeURIComponent(clientSearch)}`);
                        console.log('Client search response status:', response.status);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Client search results:', data);
                            setClients(data);
                        } else {
                            console.error('Client search failed:', response.status, response.statusText);
                        }
                    } catch (err) {
                        console.error('Error searching clients:', err);
                    }
                };

                const timeoutId = setTimeout(searchClients, 300);
                return () => clearTimeout(timeoutId);
            }, [clientSearch]);

            // Search for workers
            useEffect(() => {
                const searchWorkers = async () => {
                    if (!workerSearch.trim()) {
                        setWorkers([]);
                        return;
                    }
                    try {
                        console.log('Searching for workers with term:', workerSearch);
                        const response = await fetch(`${API_BASE}/workers/search?term=${encodeURIComponent(workerSearch)}`);
                        console.log('Worker search response status:', response.status);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Worker search results:', data);
                            setWorkers(data);
                        } else {
                            console.error('Worker search failed:', response.status, response.statusText);
                        }
                    } catch (err) {
                        console.error('Error searching workers:', err);
                    }
                };

                const timeoutId = setTimeout(searchWorkers, 300);
                return () => clearTimeout(timeoutId);
            }, [workerSearch]);

            // Search for head equipment
            useEffect(() => {
                const searchHeadEquip = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/workers/search?term=${encodeURIComponent(headEquipSearch)}&role=head_equip`);
                        if (response.ok) {
                            const data = await response.json();
                            setHeadEquipList(data);
                        }
                    } catch (err) {
                        console.error('Error searching head equipment:', err);
                    }
                };

                const timeoutId = setTimeout(searchHeadEquip, 300);
                return () => clearTimeout(timeoutId);
            }, [headEquipSearch]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim() && selectedListId) {
                    onSave(
                        selectedListId,
                        title.trim(),
                        description.trim(),
                        null, // dueDate removed
                        priority,
                        clientId || null,
                        workerId || null,
                        headEquipId || null,
                        startDatetime || null,
                        vehicleNumber.trim() || null,
                        commands.trim() || null
                    );
                    // Reset form
                    setTitle('');
                    setDescription('');
                    setSelectedListId(defaultListId || (board?.lists?.[0]?.id || ''));
                    setPriority('medium');
                    setClientId('');
                    setClientSearch('');
                    setWorkerId('');
                    setWorkerSearch('');
                    setHeadEquipId('');
                    setHeadEquipSearch('');
                    setStartDatetime('');
                    setVehicleNumber('');
                    setCommands('');
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const selectClient = (client) => {
                setClientId(client.id);
                setClientSearch(`${client.name}${client.company ? ` (${client.company})` : ''}`);
                setClients([]);
            };

            const selectWorker = (worker) => {
                setWorkerId(worker.id);
                setWorkerSearch(`${worker.name}${worker.position ? ` - ${worker.position}` : ''}`);
                setWorkers([]);
            };

            const selectHeadEquip = (worker) => {
                setHeadEquipId(worker.id);
                setHeadEquipSearch(`${worker.name}${worker.position ? ` - ${worker.position}` : ''}`);
                setHeadEquipList([]);
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>Afegir Nova Targeta</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            {showListSelection && (
                                <div className="form-group">
                                    <label>Llista:</label>
                                    <select
                                        value={selectedListId}
                                        onChange={(e) => setSelectedListId(e.target.value)}
                                        className="modal-select"
                                        required
                                    >
                                        {board?.lists?.map(list => (
                                            <option key={list.id} value={list.id}>
                                                {list.title}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <div className="form-group">
                                <label>TÃ­tol de la Targeta:</label>
                                <input
                                    type="text"
                                    placeholder="TÃ­tol de la targeta"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                    autoFocus
                                    className="modal-input"
                                    required
                                />
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Client:</label>
                                    <div className="search-container">
                                        <input
                                            type="text"
                                            placeholder="Cercar client..."
                                            value={clientSearch}
                                            onChange={(e) => setClientSearch(e.target.value)}
                                            className="modal-input"
                                        />
                                        {clients.length > 0 && clientSearch && (
                                            <div className="search-results">
                                                {clients.map(client => (
                                                    <div
                                                        key={client.id}
                                                        className="search-result-item"
                                                        onClick={() => selectClient(client)}
                                                    >
                                                        {client.name}{client.company ? ` (${client.company})` : ''}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Treballador:</label>
                                    <div className="search-container">
                                        <input
                                            type="text"
                                            placeholder="Cercar treballador..."
                                            value={workerSearch}
                                            onChange={(e) => setWorkerSearch(e.target.value)}
                                            className="modal-input"
                                        />
                                        {workers.length > 0 && workerSearch && (
                                            <div className="search-results">
                                                {workers.map(worker => (
                                                    <div
                                                        key={worker.id}
                                                        className="search-result-item"
                                                        onClick={() => selectWorker(worker)}
                                                    >
                                                        {worker.name}{worker.position ? ` - ${worker.position}` : ''}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Cap d'Equip:</label>
                                <div className="search-container">
                                    <input
                                        type="text"
                                        placeholder="Cercar cap d'equip..."
                                        value={headEquipSearch}
                                        onChange={(e) => setHeadEquipSearch(e.target.value)}
                                        className="modal-input"
                                    />
                                    {headEquipList.length > 0 && headEquipSearch && (
                                        <div className="search-results">
                                            {headEquipList.map(worker => (
                                                <div
                                                    key={worker.id}
                                                    className="search-result-item"
                                                    onClick={() => selectHeadEquip(worker)}
                                                >
                                                    {worker.name}{worker.position ? ` - ${worker.position}` : ''}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Hora d'Inici:</label>
                                    <input
                                        type="datetime-local"
                                        value={startDatetime}
                                        onChange={(e) => setStartDatetime(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Vehicle:</label>
                                    <input
                                        type="text"
                                        placeholder="NÃºmero o nom del vehicle"
                                        value={vehicleNumber}
                                        onChange={(e) => setVehicleNumber(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Prioritat:</label>
                                    <select
                                        value={priority}
                                        onChange={(e) => setPriority(e.target.value)}
                                        className="modal-select"
                                    >
                                        <option value="low">Baixa</option>
                                        <option value="medium">Mitjana</option>
                                        <option value="high">Alta</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Comandaments (Tasques):</label>
                                <textarea
                                    placeholder="Descriure les tasques que s'han de fer..."
                                    value={commands}
                                    onChange={(e) => setCommands(e.target.value)}
                                    className="modal-textarea"
                                    rows="3"
                                />
                            </div>

                            <div className="form-group">
                                <label>DescripciÃ³:</label>
                                <textarea
                                    placeholder="DescripciÃ³ addicional (opcional)"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="modal-textarea"
                                    rows="2"
                                />
                            </div>

                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fa-solid fa-plus"></i>
                                    Afegir Targeta
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditCardModal({ card, board, onSave, onDelete, onClose }) {
            const [title, setTitle] = useState(card.title);
            const [description, setDescription] = useState(card.description || '');
            const [selectedListId, setSelectedListId] = useState(card.list_id);
            const [priority, setPriority] = useState(card.priority || 'medium');
            const [clientId, setClientId] = useState(card.client_id || '');
            const [clientSearch, setClientSearch] = useState(card.client_name ? `${card.client_name}${card.client_company ? ` (${card.client_company})` : ''}` : '');
            const [clients, setClients] = useState([]);
            const [workerId, setWorkerId] = useState(card.worker_id || '');
            const [workerSearch, setWorkerSearch] = useState(card.worker_name ? `${card.worker_name}${card.worker_position ? ` - ${card.worker_position}` : ''}` : '');
            const [workers, setWorkers] = useState([]);
            const [headEquipId, setHeadEquipId] = useState(card.head_equip_id || '');
            const [headEquipSearch, setHeadEquipSearch] = useState(card.head_equip_name ? `${card.head_equip_name}${card.head_equip_position ? ` - ${card.head_equip_position}` : ''}` : '');
            const [headEquipList, setHeadEquipList] = useState([]);
            const [startDatetime, setStartDatetime] = useState(formatDateTimeForInput(card.start_datetime) || '');
            const [vehicleNumber, setVehicleNumber] = useState(card.vehicle_number || '');
            const [commands, setCommands] = useState(card.commands || '');

            // Search for clients
            useEffect(() => {
                const searchClients = async () => {
                    if (!clientSearch.trim()) {
                        setClients([]);
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE}/clients/search?term=${encodeURIComponent(clientSearch)}`);
                        if (response.ok) {
                            const data = await response.json();
                            setClients(data);
                        }
                    } catch (err) {
                        console.error('Error searching clients:', err);
                    }
                };

                const timeoutId = setTimeout(searchClients, 300);
                return () => clearTimeout(timeoutId);
            }, [clientSearch]);

            // Search for workers
            useEffect(() => {
                const searchWorkers = async () => {
                    if (!workerSearch.trim()) {
                        setWorkers([]);
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE}/workers/search?term=${encodeURIComponent(workerSearch)}`);
                        if (response.ok) {
                            const data = await response.json();
                            setWorkers(data);
                        }
                    } catch (err) {
                        console.error('Error searching workers:', err);
                    }
                };

                const timeoutId = setTimeout(searchWorkers, 300);
                return () => clearTimeout(timeoutId);
            }, [workerSearch]);

            // Search for head equipment
            useEffect(() => {
                const searchHeadEquip = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/workers/search?term=${encodeURIComponent(headEquipSearch)}&role=head_equip`);
                        if (response.ok) {
                            const data = await response.json();
                            setHeadEquipList(data);
                        }
                    } catch (err) {
                        console.error('Error searching head equipment:', err);
                    }
                };

                const timeoutId = setTimeout(searchHeadEquip, 300);
                return () => clearTimeout(timeoutId);
            }, [headEquipSearch]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    // Check if the list has changed
                    if (selectedListId !== card.list_id) {
                        // First update the card, then move it
                        onSave(
                            card.id,
                            title.trim(),
                            description.trim(),
                            priority,
                            clientId || null,
                            workerId || null,
                            headEquipId || null,
                            startDatetime || null,
                            vehicleNumber.trim() || null,
                            commands.trim() || null,
                            selectedListId // Pass the new list ID
                        );
                    } else {
                        // Just update the card
                        onSave(
                            card.id,
                            title.trim(),
                            description.trim(),
                            priority,
                            clientId || null,
                            workerId || null,
                            headEquipId || null,
                            startDatetime || null,
                            vehicleNumber.trim() || null,
                            commands.trim() || null
                        );
                    }
                }
            };

            const handleDelete = () => {
                onDelete(card.id);
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const selectClient = (client) => {
                setClientId(client.id);
                setClientSearch(`${client.name}${client.company ? ` (${client.company})` : ''}`);
                setClients([]);
            };

            const selectWorker = (worker) => {
                setWorkerId(worker.id);
                setWorkerSearch(`${worker.name}${worker.position ? ` - ${worker.position}` : ''}`);
                setWorkers([]);
            };

            const selectHeadEquip = (worker) => {
                setHeadEquipId(worker.id);
                setHeadEquipSearch(`${worker.name}${worker.position ? ` - ${worker.position}` : ''}`);
                setHeadEquipList([]);
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>Editar Targeta</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Llista:</label>
                                <select
                                    value={selectedListId}
                                    onChange={(e) => setSelectedListId(e.target.value)}
                                    className="modal-select"
                                    required
                                >
                                    {board?.lists?.map(list => (
                                        <option key={list.id} value={list.id}>
                                            {list.title}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>TÃ­tol de la Targeta:</label>
                                <input
                                    type="text"
                                    placeholder="TÃ­tol de la targeta"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                    autoFocus
                                    className="modal-input"
                                    required
                                />
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Client:</label>
                                    <div className="search-container">
                                        <input
                                            type="text"
                                            placeholder="Cercar client..."
                                            value={clientSearch}
                                            onChange={(e) => setClientSearch(e.target.value)}
                                            className="modal-input"
                                        />
                                        {clients.length > 0 && clientSearch && (
                                            <div className="search-results">
                                                {clients.map(client => (
                                                    <div
                                                        key={client.id}
                                                        className="search-result-item"
                                                        onClick={() => selectClient(client)}
                                                    >
                                                        {client.name}{client.company ? ` (${client.company})` : ''}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Treballador:</label>
                                    <div className="search-container">
                                        <input
                                            type="text"
                                            placeholder="Cercar treballador..."
                                            value={workerSearch}
                                            onChange={(e) => setWorkerSearch(e.target.value)}
                                            className="modal-input"
                                        />
                                        {workers.length > 0 && workerSearch && (
                                            <div className="search-results">
                                                {workers.map(worker => (
                                                    <div
                                                        key={worker.id}
                                                        className="search-result-item"
                                                        onClick={() => selectWorker(worker)}
                                                    >
                                                        {worker.name}{worker.position ? ` - ${worker.position}` : ''}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Cap d'Equip:</label>
                                <div className="search-container">
                                    <input
                                        type="text"
                                        placeholder="Cercar cap d'equip..."
                                        value={headEquipSearch}
                                        onChange={(e) => setHeadEquipSearch(e.target.value)}
                                        className="modal-input"
                                    />
                                    {headEquipList.length > 0 && headEquipSearch && (
                                        <div className="search-results">
                                            {headEquipList.map(worker => (
                                                <div
                                                    key={worker.id}
                                                    className="search-result-item"
                                                    onClick={() => selectHeadEquip(worker)}
                                                >
                                                    {worker.name}{worker.position ? ` - ${worker.position}` : ''}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Hora d'Inici:</label>
                                    <input
                                        type="datetime-local"
                                        value={startDatetime}
                                        onChange={(e) => setStartDatetime(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Vehicle:</label>
                                    <input
                                        type="text"
                                        placeholder="NÃºmero o nom del vehicle"
                                        value={vehicleNumber}
                                        onChange={(e) => setVehicleNumber(e.target.value)}
                                        className="modal-input"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Prioritat:</label>
                                    <select
                                        value={priority}
                                        onChange={(e) => setPriority(e.target.value)}
                                        className="modal-select"
                                    >
                                        <option value="low">Baixa</option>
                                        <option value="medium">Mitjana</option>
                                        <option value="high">Alta</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Comandaments (Tasques):</label>
                                <textarea
                                    placeholder="Descriure les tasques que s'han de fer..."
                                    value={commands}
                                    onChange={(e) => setCommands(e.target.value)}
                                    className="modal-textarea"
                                    rows="3"
                                />
                            </div>

                            <div className="form-group">
                                <label>DescripciÃ³:</label>
                                <textarea
                                    placeholder="DescripciÃ³ addicional (opcional)"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="modal-textarea"
                                    rows="2"
                                />
                            </div>

                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fas fa-save"></i>
                                    Desar
                                </button>
                                <button type="button" className="delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                    Eliminar
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CalendarAddTaskModal({ selectedDate, lists, onSave, onClose }) {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [selectedList, setSelectedList] = useState(lists[0]?.id || '');
            const [priority, setPriority] = useState('medium');

            const formatDateForDisplay = (date) => {
                // Use local date methods to avoid timezone issues
                return date.toLocaleDateString('ca-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            const formatDateForInput = (date) => {
                // IMPORTANT: Use local date methods to avoid timezone conversion
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (title.trim() && selectedList) {
                    const dueDate = formatDateForInput(selectedDate);
                    console.log('Calendar modal - selectedDate:', selectedDate);
                    console.log('Calendar modal - formatted dueDate:', dueDate);

                    await onSave(parseInt(selectedList), title.trim(), description.trim(), dueDate, priority);
                    onClose();
                }
            };

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content wide">
                        <h3>Afegir Tasca per {formatDateForDisplay(selectedDate)}</h3>
                        <form className="modal-form" onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Llista:</label>
                                <select
                                    value={selectedList}
                                    onChange={(e) => setSelectedList(e.target.value)}
                                    className="modal-select"
                                    required
                                >
                                    {lists.map(list => (
                                        <option key={list.id} value={list.id}>
                                            {list.title}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>TÃ­tol de la Tasca:</label>
                                <input
                                    type="text"
                                    placeholder="IntroduÃ¯u el tÃ­tol de la tasca"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                    autoFocus
                                    className="modal-input"
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>DescripciÃ³:</label>
                                <textarea
                                    placeholder="DescripciÃ³ de la tasca (opcional)"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="modal-textarea"
                                />
                            </div>

                            <div className="form-group">
                                <label>Prioritat:</label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value)}
                                    className="modal-select"
                                >
                                    <option value="low">Baixa</option>
                                    <option value="medium">Mitjana</option>
                                    <option value="high">Alta</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>

                            <div className="modal-buttons">
                                <button type="submit" className="save-button">
                                    <i className="fas fa-plus"></i>
                                    Afegir Tasca
                                </button>
                                <button type="button" className="cancel-button" onClick={onClose}>
                                    CancelÂ·lar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ConfirmationModal({ isOpen, title, message, onConfirm, onCancel, confirmText = "SÃ­", cancelText = "No", isDestructive = false }) {
            if (!isOpen) return null;

            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onCancel();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modal-content confirmation-modal">
                        <div className="confirmation-header">
                            <i className={`fas ${isDestructive ? 'fa-exclamation-triangle' : 'fa-question-circle'} confirmation-icon ${isDestructive ? 'destructive' : 'info'}`}></i>
                            <h3>{title}</h3>
                        </div>
                        <div className="confirmation-message">
                            {message}
                        </div>
                        <div className="modal-buttons">
                            <button
                                type="button"
                                className={`confirmation-button ${isDestructive ? 'destructive' : 'primary'}`}
                                onClick={onConfirm}
                                autoFocus
                            >
                                {confirmText}
                            </button>
                            <button
                                type="button"
                                className="cancel-button"
                                onClick={onCancel}
                            >
                                {cancelText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot ? ReactDOM.createRoot(container) : null;

        if (root) {
            root.render(<KanbanBoard />);
        } else {
            // Fallback for older React versions
            ReactDOM.render(<KanbanBoard />, container);
        }
    </script>
</body>

</html>